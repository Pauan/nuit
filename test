(import parse)

;; TODO: generic utility
(mac assert (x y)
  (w/uniq (u v)
    '(let u (on-err (fn (u)
                      (str "error: " (details u)))
                    (fn () x))
       (let v (on-err (fn (u)
                        (str "error: " (details u)))
                      (fn () y))
         (unless (is u v)
           (prn)
           (pr "failed assertion\n  expected:  ")
           (write u)
           (pr "\n  but got:   ")
           (write v)
           (prn))))))


(assert (err "invalid character \t
  \tfoobar  (line 1, column 1)
  ^")
  (parse "\tfoobar"))

(assert (err "expected an indent of 0 but got 1
   yes  (line 4, column 1)
  ^")
  (parse "
@foobar
  @quxnou
 yes
"))

(assert (err "expected an indent of 1 but got 0
  @foobar  (line 6, column 1)
  ^")
  (parse "
 @foobar
   @quxnou
   yes

@foobar
  @quxnou
  yes
"))

(assert (err "expected an indent of 2 but got 3
     @foobar  (line 6, column 3)
    ^")
  (parse "
  @foobar
    @quxnou
    yes

   @foobar
    @quxnou
    yes
"))

(assert (err "expected an indent of 0 but got 1
   questionable  (line 4, column 1)
  ^")
  (parse "
> foo bar qux
    yes maybe no
 questionable"))

(assert (err "expected any of [newline \\ s n u] but got b
  \" foo\\bar  (line 2, column 7)
        ^")
  (parse "
\" foo\\bar
  quxcorge
  nou yes
  maybe sometimes
"))

(assert (err "expected ( but got A
  \" foo\\uAB01ar  (line 2, column 8)
         ^")
  (parse "
\" foo\\uAB01ar
  quxcorge
  nou yes
  maybe sometimes
"))

(assert (err "expected space or newline but got f
  >f  (line 2, column 2)
   ^")
  (parse "
>f
"))

(assert (err "expected ( but got newline
  \" foo\\u  (line 2, column 8)
         ^")
  (parse "
\" foo\\u
  quxcorge
  nou yes
  maybe sometimes
"))

(assert (err "expected any of [0123456789abcdefABCDEF] but got )
  \" foo\\u()  (line 2, column 9)
          ^")
  (parse "
\" foo\\u()
  quxcorge
  nou yes
  maybe sometimes
"))

(assert (err "expected space or ) but got newline
  \" foo\\u(AB01 FA1  (line 2, column 17)
                  ^")
  (parse "
\" foo\\u(AB01 FA1
  quxcorge
  nou yes
  maybe sometimes
"))

(assert (err "expected space or ) but got U
  \" foo\\u(AB01 FA1U  (line 2, column 17)
                  ^")
  (parse "
\" foo\\u(AB01 FA1U
  quxcorge
  nou yes
  maybe sometimes
"))

(assert (err "expected any of [0123456789abcdefABCDEF] but got U
  \" foo\\u(AB01 U)ar  (line 2, column 14)
               ^")
  (parse "
\" foo\\u(AB01 U)ar
  quxcorge
  nou yes
  maybe sometimes
"))

(assert (err "invalid character \u0000
  foo\u0000bar  (line 1, column 4)
     ^")
  (parse "foo\u0000bar"))

(assert (err "invalid character \u0000
  \u0000foobar  (line 1, column 1)
  ^")
  (parse "\u0000foobar"))

(assert (err "invalid character \uFEFF
  f\uFEFFoobar  (line 1, column 2)
   ^")
  (parse "f\uFEFFoobar"))

(assert (err "D800 - DFFF are invalid
  \" foo\\u(D800)bar  (line 2, column 12)
             ^")
  (parse "
\" foo\\u(D800)bar"))

(assert (err "D800 - DFFF are invalid
  \" foo\\u(DFFF)bar  (line 2, column 12)
             ^")
  (parse "
\" foo\\u(DFFF)bar"))

(assert (err "expected space or newline but got f
  >foobar  (line 2, column 2)
   ^")
  (parse "
>foobar
"))

(assert (err "expected an indent of 0 but got 1
   foobar  (line 3, column 1)
  ^")
  (parse "
>
 foobar
   quxcorge
 nou yes
 maybe sometimes
"))

(assert (err "expected an indent of 0 but got 5
       foobar  (line 4, column 5)
      ^")
  (parse "
@foo
    \"
     foobar
       quxcorge
     nou yes
     maybe sometimes
"))

(assert (err "expected any of [newline \\ s n u] but got b
  \" foobar\\b  (line 1, column 10)
           ^")
  (parse "\" foobar\\b"))

(assert (err "expected any of [newline \\ s n u] but got a
  \" foo\\u(20)\\a  (line 2, column 13)
              ^")
  (parse "
\" foo\\u(20)\\a
"))

(assert (err "expected any of [0123456789abcdefABCDEF] but got space
    qux\\u(   20      20AC   )corge  (line 3, column 9)
          ^")
  (parse "
\" foo\\\\bar
  qux\\u(   20      20AC   )corge
  nou yes
  maybe sometimes
"))

(assert (err "expected any of [0123456789abcdefABCDEF] but got space
    qux\\u(20  20AC)corge  (line 3, column 12)
             ^")
  (parse "
\" foo\\\\bar
  qux\\u(20  20AC)corge
  nou yes
  maybe sometimes
"))



(assert '("foo  bar")
  (parse "
\" foo\\u(20)\\u(20)bar
"))

(assert '("\\$foobar")
  (parse "\\$foobar"))

(assert '("yestoo")
  (parse "
# foobar
 quxcorge
   nou yes
 maybe sometimes
   oneday
yestoo
"))

(assert '("foobar")
  (parse " foobar"))

(assert '(("foobar"))
  (parse " @foobar"))

(assert '("foo힙bar")
  (parse "
\" foo\\u(D799)bar"))

(assert '("foo\uE000bar")
  (parse "
\" foo\\u(E000)bar"))

(assert '("foobar")
  (parse "\uFEFFfoobar"))

(assert '(("foo" ("bar" "10")
            ("qux" "nou"))
          ("yes"))
  (parse "
@foo @bar 10
  @qux nou
@yes"))

(assert '(("foo" ("bar" "10")
            ("qux" "nou"))
          ("yes"))
  (parse "
@foo @bar 10
     @qux nou
@yes"))

(assert '(("foo" ("bar" "10"
                   ("qux" "nou")))
          ("yes"))
  (parse "
@foo @bar 10
      @qux nou
@yes"))

(assert '(("foo")
          ("yes"))
  (parse "
@foo #@bar 10
      @qux nou
@yes"))

(assert '(("foo" "")
          ("yes"))
  (parse "
@foo >
@yes"))

(assert '(("foo")
          ("yes"))
  (parse "
@foo
@yes"))

(assert '(("foo" "bar" "qux" "corge"))
  (parse "@foo bar\n  qux\n   \n  corge"))

(assert '(("foo" "bar" "qux" "corge"))
  (parse "@foo bar\n  qux\n  \n  corge"))

(assert '(("foo" "bar" "qux" "corge"))
  (parse "@foo bar\n  qux\n \n  corge"))

(assert '(("foo" "bar" "qux" "corge"))
  (parse "@foo bar\n  qux\n\n  corge"))

(assert '("foobar")
  (parse "       \nfoobar"))

(assert '("foobar" "quxcorge")
  (parse "\nfoobar  \nquxcorge"))

(assert '("foobar")
  (parse "foobar"))

(assert '("\\\"foobar")
  (parse "\\\"foobar"))

(assert '(("foo" "bar" ("testing") "qux \"\"\" yes" "corge 123" "nou@ yes")
          ("another" "one" "inb4 this#" "next thread"
            ("nested\\" "lists are cool"
              ("yes" "indeed")
              ("no" "maybe"))
            ("oh yes" "oh my")
            ("oh yes" "oh my")))
  (parse "
@foo bar
  @testing
  qux \"\"\" yes

  corge 123
  nou@ yes

@another one
  inb4 this#

  next thread
  @nested\\
    lists are cool

    @yes indeed
    @no maybe
  @ oh yes

   oh my
  @ oh yes
   oh my
"))

(assert '(("foo" "bar" ("testing") "qux \"\"\" yes" "corge 123" "nou@ yes")
          ("another" "one" "inb4 this#" "next thread"
            ("nested\\" "lists are cool"
              ("yes" "indeed")
              ("no" "maybe"))
            ("oh yes" "oh my")
            ("oh yes" "oh my")))
  (parse "

    @foo bar
      @testing
      qux \"\"\" yes

      corge 123
      nou@ yes

    @another one
      inb4 this#

      next thread
      @nested\\
        lists are cool

        @yes indeed
        @no maybe
      @ oh yes

       oh my
      @ oh yes
       oh my

"))

(assert '(() ("foobar" "qux"))
  (parse "
@
@
 foobar
 qux"))

(assert '("foo bar qux\nyes maybe no\nquestionable")
  (parse "
> foo bar qux
  yes maybe no
  questionable"))

(assert '(("foobar" "foo bar qux\n  yes maybe no\n  questionable"))
  (parse "
@foobar
  > foo bar qux
      yes maybe no
      questionable"))

(assert '("foo bar qux\n  yes maybe no\n  questionable")
  (parse "
> foo bar qux
    yes maybe no
    questionable"))

(assert '("yestoo")
  (parse "
# foobar
  quxcorge
  nou yes
  maybe sometimes
yestoo
"))

(assert '("yestoo")
  (parse "
#foobar
 quxcorge
 nou yes
 maybe sometimes
yestoo
"))

(assert '()
  (parse "
# foobar
  quxcorge
  nou yes
  maybe sometimes
"))

(assert '(("another" "one" "inb4 this#" "next thread"
            ("oh yes")
            ("oh yes" "oh my")))
  (parse "
#@foo bar
  @testing
  qux \"\"\" yes
  corge 123
  nou@ yes
@another one
  inb4 this#
  next thread
  #@nested\\
    lists are cool
    @yes indeed
    @no maybe
  @ oh yes
   #oh my
  @ oh yes
   oh my
"))

(assert '("foobar\n\nquxcorge\n\nnou yes\n\nmaybe sometimes")
  (parse "
> foobar

  quxcorge

  nou yes

  maybe sometimes
"))

(assert '("foobar\n\nquxcorge\n\nnou yes\n\nmaybe sometimes")
  (parse "
\" foobar

  quxcorge

  nou yes

  maybe sometimes
"))

(assert '("foobar\n\n\nquxcorge\n\nnou yes\n\n\nmaybe sometimes")
  (parse "
\" foobar


  quxcorge

  nou yes


  maybe sometimes
"))

(assert '("foobar\n\n\n\nquxcorge\n\nnou yes\n\n\n\nmaybe sometimes")
  (parse "
\" foobar



  quxcorge

  nou yes



  maybe sometimes
"))

(assert '("foobar quxcorge nou yes maybe sometimes")
  (parse "
\" foobar
  quxcorge
  nou yes
  maybe sometimes
"))

(assert '("foobar\nquxcorge\nnou yes\nmaybe sometimes")
  (parse "
\" foobar\\
  quxcorge\\
  nou yes\\
  maybe sometimes\\
"))

(assert '("foobar\nquxcorge\nnou yes\nmaybe sometimes" "mooooooooooo")
  (parse "
\" foobar\\
  quxcorge\\
  nou yes\\
  maybe sometimes
mooooooooooo
"))

(assert '("foobar\nquxcorge\nnou yes\nmaybe sometimes" "mooooooooooo")
  (parse "
\" foobar\\
  quxcorge\\
  nou yes\\
  maybe sometimes\\
mooooooooooo
"))

(assert '("foo\\bar qux €corge nou yes maybe sometimes")
  (parse "
\" foo\\\\bar
  qux\\u(20 20AC)corge
  nou yes
  maybe sometimes
"))

(assert '("foobar\nquxcorge\nnou yes\nmaybe sometimes")
  (parse "\n\" foobar\\  \n  quxcorge\\\n  nou yes\\\n  maybe sometimes\n"))

(assert '("" "foobar" "quxcorge" "nou yes" "maybe sometimes")
  (parse "
>
foobar
quxcorge
nou yes
maybe sometimes
"))

(assert '("foobar\n  quxcorge\nnou yes\nmaybe sometimes")
  (parse "
>
  foobar
    quxcorge
  nou yes
  maybe sometimes
"))

(assert '(("foo" "foobar\nquxcorge\nnou yes\nmaybe sometimes"))
  (parse "
@foo
    >
      foobar
      quxcorge
      nou yes
      maybe sometimes
"))

(assert '(("foo" "" "foobar" "quxcorge" "nou yes" "maybe sometimes"))
  (parse "
@foo
    >
    foobar
    quxcorge
    nou yes
    maybe sometimes
"))

(assert '(("foo" "foobar   quxcorge nou yes maybe sometimes"))
  (parse "
@foo
    \"
      foobar
        quxcorge
      nou yes
      maybe sometimes
"))

(assert '(("foo" "" "foobar" "quxcorge" "nou yes" "maybe sometimes"))
  (parse "
@foo
    \"
    foobar
    quxcorge
    nou yes
    maybe sometimes
"))

(assert '("foobar\\s")
  (parse "> foobar\\s"))

(assert '("foobar\\n")
  (parse "> foobar\\n"))

(assert '("foobar\\n\nquxcorge")
  (parse "
> foobar\\n
  quxcorge
"))

(assert '("foobar ")
  (parse "\" foobar\\s"))

(assert '("foobar\n")
  (parse "\" foobar\\n"))

(assert '("foobar\n quxcorge")
  (parse "
\" foobar\\n
  quxcorge
"))
